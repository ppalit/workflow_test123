name: Create App Folder from Templates

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "Enter the name of your app (e.g., app1, app2)"
        required: true
      environment:
        description: "Select an environment"
        required: true
        type: choice
        options:
          - "dev"
          - "qa"
          - "prod"
      predefined_option:
        description: "Select a predefined option"
        required: true
        type: choice
        options:
          - "Option1"
          - "Option2"
          - "Option3"
      manual_templates:
        description: "Enter additional template files manually (comma-separated, e.g., ref2.txt,ref3.txt)"
        required: false

permissions:
  contents: write

jobs:
  create-folder:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Get GitHub Username
        id: get_username
        run: echo "username=${{ github.actor }}" >> $GITHUB_ENV

      - name: Define Variables
        id: define_vars
        run: |
          APP_NAME="${{ github.event.inputs.app_name }}"
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          APP_PATH="${APP_NAME}/${ENVIRONMENT}"
          BRANCH_NAME="users/${{ env.username }}/${APP_NAME}-${ENVIRONMENT}"

          echo "App Name: $APP_NAME"
          echo "Environment: $ENVIRONMENT"
          echo "App Path: $APP_PATH"
          echo "Branch Name: $BRANCH_NAME"

          echo "app_name=$APP_NAME" >> $GITHUB_ENV
          echo "environment=$ENVIRONMENT" >> $GITHUB_ENV
          echo "app_path=$APP_PATH" >> $GITHUB_ENV
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Check if App Exists in Any Environment
        id: check_app
        run: |
          for env in dev qa prod; do
            if [ -d "${{ env.app_name }}/$env" ]; then
              echo "ðŸš« The app '${{ env.app_name }}' already exists in the '$env' environment!"
              echo "app_exists=true" >> $GITHUB_ENV
              exit 0
            fi
          done
          echo "âœ… The app does not exist in any environment. Proceeding with creation."
          echo "app_exists=false" >> $GITHUB_ENV

      - name: Stop if App Already Exists
        if: env.app_exists == 'true'
        run: |
          echo "ðŸš« The app '${{ env.app_name }}' already exists in another environment. No changes will be made."
          exit 0

      - name: Determine Selected Templates
        if: env.app_exists == 'false'
        run: |
          case "${{ github.event.inputs.predefined_option }}" in
            "Option1")
              SELECTED_FILES="ref1.txt,ref5.txt"
              ;;
            "Option2")
              SELECTED_FILES="ref2.txt,ref3.txt"
              ;;
            "Option3")
              SELECTED_FILES="ref4.txt"
              ;;
          esac
          
          # Add manual templates if provided
          if [[ -n "${{ github.event.inputs.manual_templates }}" ]]; then
            SELECTED_FILES="$SELECTED_FILES,${{ github.event.inputs.manual_templates }}"
          fi

          echo "Final selected files: $SELECTED_FILES"
          echo "files=$SELECTED_FILES" >> $GITHUB_ENV

      - name: Create New Branch
        if: env.app_exists == 'false'
        run: |
          git checkout -b "${{ env.branch_name }}"

      - name: Create App Folder and Copy Files
        if: env.app_exists == 'false'
        run: |
          mkdir -p "${{ env.app_path }}"
          IFS=',' read -ra FILES <<< "$files"
          COPIED_FILES=""
          for file in "${FILES[@]}"; do
            if [[ -f "example/$file" ]]; then
              cp "example/$file" "${{ env.app_path }}/"
              COPIED_FILES+="$file\n"
            else
              echo "Warning: example/$file does not exist."
            fi
          done
          
          echo "Copied Files:"
          echo -e "$COPIED_FILES"
          echo "copied_files=$COPIED_FILES" >> $GITHUB_ENV

      - name: Commit and Push Changes
        if: env.app_exists == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"
          git add .
          git commit -m "Created folder ${{ env.app_path }} with selected templates" || echo "No changes to commit"
          git push origin "${{ env.branch_name }}"

      - name: Provide PR Link and File Summary
        if: env.app_exists == 'false'
        run: |
          echo "## ðŸŽ‰ New Branch Created!" >> $GITHUB_STEP_SUMMARY
          echo "Branch: ${{ env.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "[Create a Pull Request](https://github.com/${{ github.repository }}/compare/main...${{ env.branch_name }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‚ Files Created in '${{ env.app_path }}':" >> $GITHUB_STEP_SUMMARY
          echo "```\n${{ env.copied_files }}```" >> $GITHUB_STEP_SUMMARY
